---
title: "Cleaning the GPS Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("C:/Users/Danielle Glass/Documents/RWorkingDirectory2/Sheepies3")
```

### Cutting the GPS Data

## Subsetting by Range & Individual Sheep ID

First, I uploaded the GPS data. I checked for duplicates - there were none. Then, I subset the data for only the mountain ranges that I am interested in: South Bristols (BrsS), Marbles (Marb), Nopah (Nopa), Castle-Piute (CMPR), and Newberry-Rodman-Ord (NROM). Then I subset to only the individual bighorn that I am interested in - those with fix rates of 4 hours or less.

A list of bighorn whose collars are every four hours:

Marbles: BHS_1581 F, BHS_1595 F (died on 8/5), BHS_1588 F
South Bristols: BHS_1580 F, 
Nopah: BHS_1738 F
CMPR: none
NROM: BHS_1568 F (went to community center), BHS_1565 F, BHS_1567 F, BHS_1564 F, BHS_1677 F, BHS_1563 M (should cut off early b/c travels into East Ord)


A list of bighorn whose collars are every hour or less:

Marbles: BHS_1589 F (very beginning every four hours?), BHS_1584 F, BHS_1582 F, BHS_1577 F, BHS_1683 M, BHS_1682 M, BHS_1684 M (died on 8/17)
South Bristols: BHS_1688 M, BHS_1685 M, BHS_1689 M, BHS_1687 F, BHS_1686 M
Nopah: BHS_1736 F, BHS_1740 F, BHS_1739 M
CMPR: BHS_1730 F, BHS_1733 F
NROM: none

```{r}
allgpsdata <- read.csv("AllGPSData20190501to20190912.csv", header = TRUE, sep = ",")
# str(allgpsdata)
library(tidyverse)
summary(duplicated(allgpsdata))
rangegpsdata <- allgpsdata[allgpsdata$MountainRange == "BrsS" | allgpsdata$MountainRange == "Marb" | allgpsdata$MountainRange == "Nopa" | allgpsdata$MountainRange == "CMPR" | allgpsdata$MountainRange == "NROM", ]
# View(rangegpsdata)
# str(rangegpsdata)
rangeidgpsdata <- rangegpsdata[rangegpsdata$KI_Known_ID == "BHS_1581" | rangegpsdata$KI_Known_ID == "BHS_1595" | rangegpsdata$KI_Known_ID == "BHS_1588" | rangegpsdata$KI_Known_ID == "BHS_1580" | rangegpsdata$KI_Known_ID == "BHS_1738" | rangegpsdata$KI_Known_ID == "BHS_1568" | rangegpsdata$KI_Known_ID == "BHS_1565" | rangegpsdata$KI_Known_ID == "BHS_1567" | rangegpsdata$KI_Known_ID == "BHS_1564" | rangegpsdata$KI_Known_ID == "BHS_1677" | rangegpsdata$KI_Known_ID == "BHS_1563" | rangegpsdata$KI_Known_ID == "BHS_1589" | rangegpsdata$KI_Known_ID == "BHS_1584" | rangegpsdata$KI_Known_ID == "BHS_1582" | rangegpsdata$KI_Known_ID == "BHS_1577" | rangegpsdata$KI_Known_ID == "BHS_1683" | rangegpsdata$KI_Known_ID == "BHS_1682" | rangegpsdata$KI_Known_ID == "BHS_1684" | rangegpsdata$KI_Known_ID == "BHS_1688" | rangegpsdata$KI_Known_ID == "BHS_1685" | rangegpsdata$KI_Known_ID == "BHS_1689" | rangegpsdata$KI_Known_ID == "BHS_1687" | rangegpsdata$KI_Known_ID == "BHS_1686" | rangegpsdata$KI_Known_ID == "BHS_1736" | rangegpsdata$KI_Known_ID == "BHS_1740" | rangegpsdata$KI_Known_ID == "BHS_1739" | rangegpsdata$KI_Known_ID == "BHS_1730" | rangegpsdata$KI_Known_ID == "BHS_1733", ]
# View(rangeidgpsdata)
rangeidgpsdata$TimeLocal <- as.character(rangeidgpsdata$TimeLocal)
rangeidgpsdata$DateTimeLocalTest <- rangeidgpsdata$DateTimeLocal
library(lubridate)
rangeidgpsdata$DateTimeLocalTest <- strptime(rangeidgpsdata$DateTimeLocalTest, "%m/%d/%Y %H:%M")
rangeidgpsdata$DateTimeLocalTestct <- as.POSIXct(rangeidgpsdata$DateTimeLocalTest, tz = "America/Los_Angeles", format = "%m/%d/%Y %H:%M")

```
Subsetting the data to when I had camera data for

I next subset the data to the time periods that I had camera data for. Keeping with my visitation analyses, I cut the GPS data to only include days when the whole 24-hour had camera coverage, and camera coverage was complete.

Marbles:
2019-05-18 - 2019-05-24
2019-06-05 - 2019-06-11
2019-06-19 - 2019-06-22
2019-06-26 - 2019-06-29
2019-07-11 - 2019-07-13
2019-07-18 - 2019-07-24
2019-08-01 - 2019-08-03
2019-08-07 - 2019-08-09

South Bristols:
2019-06-05 - 2019-06-15
2019-06-19 - 2019-07-28
2019-08-02 - 2019-08-11

Nopah:
2019-06-07 - 2019-06-12
2019-06-26 - 2019-07-07
2019-07-17 - 2019-07-28
2019-07-30 - 2019-08-06

Castle Piutes:
2019-05-24 - 2019-05-30
2019-06-21 - 2019-06-26
2019-07-12 - 2019-07-14
2019-07-31 - 2019-08-03
2019-08-06 - 2019-08-14

NROM:
2019-06-28 - 2019-07-01
2019-07-10 - 2019-07-12
2019-07-21
2019-08-09 - 2019-08-18
2019-08-21

```{r}
marbidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "Marb", ]
marbidgpsdatacut <- marbidgpsdata[(marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-05-18 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-05-24 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-05 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-11 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-19 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-22 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-26 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-29 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-11 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-13 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-18 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-24 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-01 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-03 23:59:59")) | (marbidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-07 00:00:00") & marbidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-09 23:59:59")), ]

sbrsidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "BrsS", ]
sbrsidgpsdatacut <- sbrsidgpsdata[(sbrsidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-05 00:00:00") & sbrsidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-15 23:59:59")) | (sbrsidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-19 00:00:00") & sbrsidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-28 23:59:59")) | (sbrsidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-02 00:00:00") & sbrsidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-11 23:59:59")), ]

cmpridgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "CMPR", ]
cmpridgpsdatacut <- cmpridgpsdata[(cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-05-24 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-05-30 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-21 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-26 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-12 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-14 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-31 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-03 23:59:59")) | (cmpridgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-06 00:00:00") & cmpridgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-14 23:59:59")), ]

nopaidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "Nopa", ]
nopaidgpsdatacut <- nopaidgpsdata[(nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-07 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-06-12 23:59:59")) | (nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-26 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-07 23:59:59")) | (nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-17 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-28 23:59:59")) | (nopaidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-30 00:00:00") & nopaidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-06 23:59:59")), ]

nromidgpsdata <- rangeidgpsdata[rangeidgpsdata$MountainRange == "NROM", ]
nromidgpsdatacut <- nromidgpsdata[(nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-06-28 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-01 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-10 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-12 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-07-21 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-07-21 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-09 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-18 23:59:59")) | (nromidgpsdata$DateTimeLocalTestct >= as.POSIXct("2019-08-21 00:00:00") & nromidgpsdata$DateTimeLocalTestct <= as.POSIXct("2019-08-21 23:59:59")), ]

allidgpsdatacut <- rbind(marbidgpsdatacut, sbrsidgpsdatacut, cmpridgpsdatacut, nopaidgpsdatacut, nromidgpsdatacut)
# I removed the entries with missing latitudes or longitudes from the dataset.
allidgpsdatacut1 <- allidgpsdatacut[is.na(allidgpsdatacut$Latitude) == FALSE, ]
allidgpsdatacut2 <- allidgpsdatacut1[is.na(allidgpsdatacut1$Longitude) == FALSE, ]

#Removed GPS points for after 1595 died. RIP.
not1595 <- allidgpsdatacut2[allidgpsdatacut2$KI_Known_ID != "BHS_1595", ]
is1595 <- allidgpsdatacut2[allidgpsdatacut2$KI_Known_ID == "BHS_1595", ]
is1595cut <- is1595[(is1595$DateTimeLocalTestct < as.POSIXct("2019-08-05 00:00:00")), ]
allidgpsdatacut3 <- rbind(not1595, is1595cut)

```

Subsetting to every hour and four hour

To remove the locations that were taken at 20 minute fix rates, I subset by the rows where the minutes were between 55 and 10. The number of rows before subsetting was `r nrow(rangeidgpsdata` while the number of rows after subsetting was `r nrow(rangeidhour)`, demonstrating that rows with locations taken not close to the hour mark were removed. 

After double checking that all the four-hour collars were on the same schedule, I then subset the gps data to only the rows where the hours were 00, 04, 08, 12, 16, and 20. This reason for this subsetting was to make all the collars be on the same, four hour schedule in order to make them comparable.

```{r}

# Removing the 20 min fixes
# rangeidhour includes collars on both 1-hour and 4-hour fix rates
rangeidhour <- subset(allidgpsdatacut3, format(allidgpsdatacut3$DateTimeLocalTest, "%M") %in% c('00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '55', '56', '57', '58', '59', '54', '53', '52', '51', '50'))
## I double checked the sheep that are every four hours to make sure that they are on a 0-4-8-12-16-20-24 schedule. They are all.
rangeidfourhour <- subset(rangeidhour, format(rangeidhour$DateTimeLocalTest, "%H") %in% c('00', '04', '08', '12', '16', '20', '24'))
# Including every hour as ~18,000 gps observations, including only every four hour as ~6,000 observations. Both include 28 individual sheep. 


## Will need to do the amount of time between points for both time schedules before doing any of my 4 gps movement types.


```

### Cleaning the GPS Data

## Mapping the GPS Data

```{r}
# Making an individually identifiable ID for each point
rangeidhour$IndPoint <- paste(rangeidhour$KI_Known_ID, rangeidhour$DateTimeLocalTestct)

library(maptools)
plotattempt <- SpatialPointsDataFrame(rangeidhour[6:5], rangeidhour[21])
plot(plotattempt)

# library(adehabitatLT)
# ltrangeidhour <- as.ltraj(xy = rangeidhour[, c("Latitude", "Longitude")], date = rangeidhour$DateTimeLocalTestct, id = rangeidhour$IndPoint)
# View(ltrangeidhour)

# data.lt_Desert <- as.ltraj(xy = DesertDataDanielleNoDuplicates[, c("UTME", "UTMN")], date = DesertDataDanielleNoDuplicates$DateTimeC, id = DesertDataDanielleNoDuplicates$ID)
#maybe need to convert to UTM first?

library(moveHMM)

names(rangeidhour)[names(rangeidhour) == "KI_Known_ID"] <- "ID"
rangeidhour1 <- rangeidhour[with(rangeidhour, order(ID, DateTimeLocalTestct)), ]
prangeidhour <- prepData(rangeidhour1, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(prangeidhour, compact = T)

library(ggmap)
# plotSat(prangeidhour, zoom = 8)
# Doesn't work because need Google API key????

# Marbles before cleaning
marbidhour <- rangeidhour1[rangeidhour1$MountainRange == "Marb", ]
pmarbidhour <- prepData(marbidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pmarbidhour, compact = T)
nrow(pmarbidhour)
#5670 points for Marbles before cleaning.

# South Bristols before cleaning
sbrsidhour <- rangeidhour1[rangeidhour1$MountainRange == "BrsS", ]
psbrsidhour <- prepData(sbrsidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(psbrsidhour, compact = T)
nrow(psbrsidhour)
# 7533 points for SBrs before cleaning.

#Nopah before cleaning
nopaidhour <- rangeidhour1[rangeidhour1$MountainRange == "Nopa", ]
pnopaidhour <- prepData(nopaidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pnopaidhour, compact = T)
nrow(pnopaidhour)
#2655 points for Nopa before cleaning.

#Castle Piute before cleaning
cmpridhour <- rangeidhour1[rangeidhour1$MountainRange == "CMPR", ]
pcmpridhour <- prepData(cmpridhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pcmpridhour, compact = T)
nrow(pcmpridhour)
#1135 points for CMPR before cleaning.

# NROM before cleaning
nromidhour <- rangeidhour1[rangeidhour1$MountainRange == "NROM", ]
pnromidhour <- prepData(nromidhour, type = "LL", coordNames = c("Longitude", "Latitude"))
plot(pnromidhour, compact = T)
nrow(pnromidhour)
# 754 locations for NROM before cleaning.

```
Before looking at HDOP, I first deleted points considered to have location error based on their impossible elevation data (D'Eon et al. 2002).The range of elevations possible in each mountain range was calculated by drawing a polygon around each mountain range outside of CDFW's bighorn population range maps using Caltopo. All points outside of these possible range were eliminated.

Using CalTopo: 
Marbles: 597' - 3840' (181 m - 1171 m)
South Bristols: 703' - 3269' (214 m - 997 m)
NROM: 1800'-6095' (548 m - 1858 m)
Castle Piute: 4000'-5185' (1219 m - 1580 m)
Nopah: 1392'-5249' (424 m - 1599 m)

```{r}
# Marbles
boxplot(pmarbidhour$Altitude)
pmarbidhouralt <- pmarbidhour[(pmarbidhour$Altitude >= 181) & (pmarbidhour$Altitude <= 1171), ]
nrow(pmarbidhouralt)
# Marbles now have 5475 points, instead of 5670 points.
plot(pmarbidhouralt, compact = T)

# South Bristols
boxplot(psbrsidhour$Altitude)
psbrsidhouralt <- psbrsidhour[(psbrsidhour$Altitude >= 214) & (psbrsidhour$Altitude <= 997), ]
nrow(psbrsidhouralt)
# South Bristols now has 7196 points, before had 7533 points.
plot(psbrsidhouralt, compact = T)

#Nopah
boxplot(pnopaidhour$Altitude)
pnopaidhouralt <- pnopaidhour[(pnopaidhour$Altitude >= 424) & (pnopaidhour$Altitude <= 1599), ]
nrow(pnopaidhouralt)
# Nopah now has 2390 points, before had 2655 points.
plot(pnopaidhouralt, compact = T)

#Castle Piutes
boxplot(pcmpridhour$Altitude)
pcmpridhouralt <- pcmpridhour[(pcmpridhour$Altitude >= 1219) & (pcmpridhour$Altitude <= 1580), ]
nrow(pcmpridhouralt)
# Castle Piute now has 1075 points, before had 1135 points.
plot(pcmpridhouralt, compact = T)

# NROM
boxplot(pnromidhour$Altitude)
pnromidhouralt <- pnromidhour[(pnromidhour$Altitude >= 548) & (pnromidhour$Altitude <= 1858), ]
nrow(pnromidhouralt)
# NROM has 723 points, before had 754 points.
plot(pnromidhouralt, compact = T)
```

I then eliminated the points with a DOP above 10 (Lewis et al. 2007), as these points most likely are not spatially accurate due to minimum distribution of the satellites locating the collar. It is worth noting that these points 


```{r}
# Marbles
boxplot(pmarbidhouralt$DOP)
dopmarb <- pmarbidhouralt[pmarbidhouralt$DOP <= 10, ]
nrow(dopmarb)
# Marb now has 5420 points, before had 5475.
plot(dopmarb, compact = T)

# South Bristols
boxplot(psbrsidhouralt$DOP)
dopsbrs <- psbrsidhouralt[psbrsidhouralt$DOP <= 10, ]
nrow(dopsbrs)
# SBrs now has 7150 points, before had 7196.
plot(dopsbrs, compact = T)

# Nopah
boxplot(pnopaidhouralt$DOP)
dopnopa <- pnopaidhouralt[pnopaidhouralt$DOP <= 10, ]
nrow(dopnopa)
# Nopah now has 2371 points, before had 2390.
plot(dopnopa, compact = T)

# Castle Piute
boxplot(pcmpridhouralt$DOP)
dopcmpr <- pcmpridhouralt[pcmpridhouralt$DOP <= 10, ]
nrow(dopcmpr)
# Castle Piute now has 1065 points, before had 1075 points.
plot(dopcmpr, compact = T)

# NROM
boxplot(pnromidhouralt$DOP)
dopnrom <- pnromidhouralt[pnromidhouralt$DOP <= 10, ]
nrow(dopnrom)
# NROM now has 720 points, before had 723.
plot(dopnrom, compact = T)
```

I next examined the relative fix rate by mountain range to check for topographic bias. 

```{r}



```

```{r}
library(rosm)
library(prettymapr)

marbles <- makebbox(34.743890,-115.475526,34.521739,-115.699376)

# n, e, s, w
bmaps.plot(marbles, type = "Aerial", zoom = 10)


# sp package
# talk to Lorena
raster()

library(moveHMM)


# JUNK CODE FROM ATTEMPTS:
# ggmap(get_stamenmap(bbox = c(left = -115.656813, bottom = 34.648079, right = -115.471502, top = 34.639717), maptype = "terrain", crop = FALSE, zoom = 12))

# install.packages("devtools")
# install.packages("ggmap")
# library(ggmap)
# library(ggplot2)
# library("devtools")
# marblesbasemap <- get_map(location = c(lon = 115.582657, lat = 34.641645), zoom = 11, maptype = 'hybrid', source = 'stamen') 

# bbox <- c(left = 34.639717, bottom = 115.471502, right = 34.648079, top = 115.656813)
# ggmap(get_map(bbox, zoom = 13))

# bbox <- get_stamenmap(bbox = c(left = 34.639717, bottom = 115.471502, right = 34.648079, top = 115.656813), maptype = "terrain", crop = FALSE, zoom = 10)

# Attempt #2
# get_map(location = c(lon = -115.571137, lat = 34.636558), zoom = 10, scale = "auto", maptype = "terrain", source = "google")

```



```{r}

raster()
```

